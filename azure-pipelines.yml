trigger:
  branches:
    include:
      - main

variables:
  BuildConfiguration: release
  azureSubscription: 'dotnet'  # Replace with your Azure subscription name
  webAppName: 'dotnet-mv'     # Replace with your Azure Web App name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Install and Build Artifacts
  jobs:
  - job: buildArtifacts
    displayName: Build Artifacts
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: UseDotNet@2
      displayName: Install .NET 6 SDK
      inputs:
        packageType: sdk
        version: 6.0.x
        installationPath: $(Agent.ToolsDirectory)/dotnet

    - task: DotNetCoreCLI@2
      displayName: Restore NuGet Packages
      inputs:
        command: restore
        projects: '**/WebApp.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build Web App
      inputs:
        projects: '**/WebApp.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Run Unit Tests
      inputs:
        command: test
        projects: '**/*UnitTest*.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Create Web App Package (.zip)
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishPipelineArtifact@0
      displayName: Publish Pipeline Artifacts
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)
        artifactName: Webapp

- stage: Deploy
  displayName: Deployment
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployLinuxWebApp
    displayName: Deploy Linux Web App
    environment: 'development'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download Pipeline Artifact
            inputs:
              artifactName: Webapp
              targetPath: $(System.ArtifactsDirectory)

          - task: AzureWebApp@1
            displayName: Azure Web App Deploy
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(webAppName)
              package: '$(System.ArtifactsDirectory)/*.zip'
